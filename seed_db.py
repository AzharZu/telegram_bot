# seed_db.py — база данных для FindFood 4.0
from contextlib import closing

from db import get_conn, init_db

# Синонимы для поискового словаря.
SYNONYMS = {
    "чизкейк": ["cheesecake", "десерт", "sweet", "сырный торт"],
    "брауни": ["brownie", "десерт", "шоколад"],
    "десерт": ["sweet", "выпечка", "торт", "кофейня"],
    "рамен": ["лапша", "суп", "ramen", "азиатское", "острое", "spicy"],
    "рамэн": ["рамен", "лапша", "суп", "азиатская", "острое"],
    "лапша": ["рамен", "вок", "азиатское"],
    "пицца": ["pizza", "итальянское", "сыр", "маргарита"],
    "бургер": ["бургеры", "сэндвич", "гриль", "мясо"],
    "кофе": ["кофейня", "десерт", "sweet", "latte"],
    "кофейня": ["кофе", "sweet", "десерт"],
    "кафе": ["кофейня", "coffee", "десерт", "сладкое"],
    "завтрак": ["панкейки", "омлет", "авокадо", "кофейня"],
    "суши": ["роллы", "японская", "рыба"],
    "роллы": ["суши", "японская", "рыба"],
    "том ям": ["том-ям", "тайская", "суп", "острое"],
    "тако": ["taco", "мексиканская", "острое", "spicy"],
    "фахитас": ["mexican", "солёное", "курица", "острое"],
    "салат": ["healthy", "овощи", "полезное"],
    "суп": ["том ям", "борщ", "рамэн"],
    "овсянка": ["каша", "healthy", "завтрак"],
    "боул": ["поке", "healthy", "лёгкое"],
    "гриль": ["барбекю", "стейк", "мясо"],
    "острое": ["spicy", "азиатское", "чили"],
    "здоровое": ["healthy", "лёгкое", "овощи"],
}

# Полезные мапперы.
def media_for_category(category: str) -> str:
    mapping = {
        "sweet": "sweet.jpg",
        "salty": "salty.jpg",
        "spicy": "spicy.jpg",
        "healthy": "healthy.jpg",
    }
    return mapping.get(category, "happy.png")


def media_for_tags(tags: str) -> str:
    lower = (tags or "").lower()
    if any(key in lower for key in ("слад", "десерт", "чизкейк")):
        return "sweet.jpg"
    if any(key in lower for key in ("остро", "чили", "азиат", "рамен")):
        return "spicy.jpg"
    if any(key in lower for key in ("здоров", "боул", "овощ", "веган", "легкое")):
        return "healthy.jpg"
    return "salty.jpg"


RECIPES = [
    # SWEET
    ("Чизкейк без выпечки", "печенье, масло, сливочный сыр, сметана, сахар",
     "Измельчи печенье с маслом → основа. Смешай крем. Залей и охлади 4 ч.",
     "sweet", "european", "десерт;чизкейк;сладкое", "десерт;торт;кофейня;маскарпоне"),
    ("Брауни", "шоколад, масло, сахар, яйца, мука",
     "Растопи шоколад+масло, вмешай сахар и яйца, добавь муку. 180°C ~25 мин.",
     "sweet", "american", "брауни;шоколад;сладкое", "шоколадный пирог;десерт"),
    ("Тирамису", "савоярди, кофе, маскарпоне, яйца, какао",
     "Печенье в кофе, крем слоями, сверху какао. Охладить 4 ч.",
     "sweet", "italian", "десерт;итальянский", "кофе;маскарпоне;сладкое"),
    ("Блины с вареньем", "мука, молоко, яйца, сахар, варенье",
     "Замеси жидкое тесто, жарь тонко, подавай с вареньем/сгущёнкой.",
     "sweet", "russian", "блины;сладкое", "блинчики;десерт"),
    ("Шарлотка", "яблоки, мука, яйца, сахар, корица",
     "Собери тесто, добавь яблоки и корицу, выпекай до румяности.",
     "sweet", "russian", "пирог;яблочный;сладкое", "десерт;выпечка"),
    ("Панкейки", "мука, молоко, яйца, разрыхлитель, сахар",
     "Смешай ингредиенты, жарь небольшими кружками, подавай с сиропом.",
     "sweet", "american", "панкейки;завтрак;сладкое", "оладьи;сироп;десерт"),
    ("Маффины с черникой", "мука, яйца, масло, сахар, черника",
     "Замеси тесто, вмешай ягоды, выпекай в формах 20–25 мин.",
     "sweet", "european", "маффины;ягоды;сладкое", "кексы;десерт"),
    ("Эклеры", "мука, яйца, масло, молоко, крем, шоколад",
     "Заварное тесто, выпечка палочек, начинка кремом, глазурь.",
     "sweet", "french", "эклеры;сладкое", "десерт;кондитерские"),
    ("Вафли", "мука, молоко, яйца, масло, сахар",
     "Тесто и вафельница. Подавай с фруктами, мороженым или шоколадом.",
     "sweet", "european", "вафли;завтрак;сладкое", "десерт;выпечка"),
    ("Сырники", "творог, яйца, мука, сахар, сметана",
     "Сформируй лепёшки из творога, обжарь, подавай со сметаной.",
     "sweet", "russian", "сырники;завтрак;сладкое", "творог;десерт"),

    # SALTY
    ("Пицца Маргарита", "тесто, томаты, моцарелла, базилик",
     "Раскатай, томаты+сыр, 220°C 10–12 мин.",
     "salty", "italian", "пицца;сыр;итальянская", "маргарита;пиццерия;неаполитанская"),
    ("Классический бургер", "булочки, котлета, сыр, салат, соус",
     "Обжарь котлету, прогрей булочки, собери бургер.",
     "salty", "american", "бургер;мясо;солёное", "бургеры;фастфуд;сэндвич"),
    ("Паста Карбонара", "спагетти, яйца, бекон, пармезан, сливки",
     "Сварить пасту, обжарить бекон, вмешать сливки+яйцо.",
     "salty", "italian", "паста;карбонара;солёное", "макароны;итальянская"),
    ("Салат Цезарь", "курица, салат, сухарики, соус, пармезан",
     "Обжарь курицу, смешай листья+соус, посыпь сыром.",
     "salty", "european", "салат;цезарь;солёное", "курица;сыр;соус"),
    ("Шакшука", "яйца, томаты, перец, лук, специи",
     "Томаты с перцем и луком тушить, сделать лунки, запечь яйца.",
     "salty", "middle-east", "яйца;томаты;кастрюля", "завтрак;солёное"),
    ("Плов по-узбекски", "рис, мясо, морковь, лук, специи, чеснок",
     "Обжарь мясо+овощи, добавь рис и воду, томи 40 мин.",
     "salty", "asian", "плов;узбекский;солёное", "рис;мясо"),
    ("Борщ", "свёкла, капуста, картофель, морковь, говядина",
     "Сварить бульон, добавить овощи, томат, довести до готовности.",
     "salty", "ukrainian", "борщ;суп;солёное", "сметана;горячее"),
    ("Пюре с котлетой", "картофель, молоко, масло, фарш",
     "Сварить картофель → пюре. Сформировать котлеты и обжарить.",
     "salty", "home", "домашнее;ужин", "классика;солёное"),
    ("Фахитас", "курица, перец, лук, специи, тортильи",
     "Обжарить курицу с перцем, подать в тортильях.",
     "salty", "mexican", "фахитас;мексиканская", "курица;перец"),
    ("Окрошка", "кефир/квас, картофель, огурец, яйца, колбаса",
     "Все нарезать, залить кефиром/квасом, подать холодной.",
     "salty", "russian", "суп;летний;солёное", "холодный суп;освежающее"),
    ("Пельмени", "тесто, фарш, лук, специи",
     "Слепить пельмени, отварить, подать со сметаной/маслом.",
     "salty", "russian", "пельмени;солёное", "дома;быстро"),
    ("Ризотто с грибами", "рис арборио, бульон, пармезан, грибы",
     "Томить рис с бульоном, вмешать грибы и сыр.",
     "salty", "italian", "ризотто;грибы;солёное", "итальянская;сыр"),
    ("Лазанья", "листы, фарш, томат, бешамель, сыр",
     "Слои: листы, соус, фарш, сыр. Запекать до корочки.",
     "salty", "italian", "лазанья;запеканка", "итальянская;сыр"),
    ("Греческий салат", "огурец, помидор, перец, оливки, фета",
     "Нарезать и смешать с оливковым маслом.",
     "salty", "greek", "салат;сыр;овощи", "фета;летний"),

    # SPICY
    ("Чили кон карне", "фарш, фасоль, перец чили, томаты, специи",
     "Обжарь фарш, добавь фасоль и томаты, туши 30 мин.",
     "spicy", "mexican", "чили;суп;острое", "мексиканская;густой"),
    ("Суп Том Ям", "креветки, кокос, лайм, грибы, паста том ям",
     "Бульон + паста, добавить креветки, 10 минут.",
     "spicy", "thai", "том ям;суп;острое", "тайская;кокос"),
    ("Рамен с курицей", "куриный бульон, лапша, курица, соевый соус, имбирь, чили",
     "Сварить бульон, добавить лапшу и курицу, приправить соевым соусом и чили.",
     "spicy", "japanese", "рамен;лапша;острое", "азиатское;суп;ramen"),
    ("Лапша по-корейски", "лапша, морковь, перец, чеснок, чили",
     "Сварить лапшу, обжарить овощи, смешать с соусом.",
     "spicy", "korean", "лапша;острое;азиатское", "рамен;острый"),
    ("Курица по-азиатски", "курица, соевый соус, чеснок, имбирь, чили",
     "Замариновать, быстро обжарить с овощами, подать с рисом.",
     "spicy", "asian", "курица;острое;вок", "жаркое;имбирь"),
    ("Пад Тай", "рисовая лапша, креветки/курица, соус тамаринд",
     "Обжарить лапшу с соусом, яйцом, орехами.",
     "spicy", "thai", "пад тай;лапша;острое", "тайская;улица"),
    ("Шаверма острая", "лаваш, курица, овощи, острый соус",
     "Собрать в лаваш и прогреть на гриле.",
     "spicy", "middle-east", "шаурма;острое;стритфуд", "лаваш;соус"),

    # HEALTHY
    ("Тост с авокадо и яйцом пашот", "авокадо, хлеб, яйцо, лимон",
     "Яйцо пашот, авокадо на тост, приправить лимоном.",
     "healthy", "healthy", "тост;авокадо;завтрак", "легкое;полезное"),
    ("Овсянка с фруктами", "овсянка, молоко, банан, яблоко, мёд, орехи",
     "Свари, добавь фрукты и мёд, посыпь орехами.",
     "healthy", "healthy", "овсянка;полезное;завтрак", "каша;здоровое"),
    ("Куриный суп с лапшой", "курица, овощи, лапша, зелень",
     "Сварить бульон, добавить овощи и лапшу.",
     "healthy", "russian", "суп;домашний;нейтральное", "легкий;куриный"),
    ("Смузи банан-клубника", "банан, клубника, йогурт, мёд, лёд",
     "Взбей в блендере, подай холодным.",
     "healthy", "healthy", "смузи;напиток;полезное", "здоровое;ягоды"),
    ("Боул с лососем", "рис, лосось, авокадо, огурец, соус",
     "Собери боул, полей соусом, подай свежим.",
     "healthy", "healthy", "поке;боул;здоровое", "рыба;полезное"),
    ("Омлет с овощами", "яйца, молоко, перец, томаты, сыр",
     "Взбить яйца, добавить овощи, обжарить под крышкой.",
     "healthy", "home", "омлет;завтрак;нейтральное", "легкое;быстро"),
    ("Гречка с грибами", "гречка, грибы, лук, масло",
     "Отварить гречку, обжарить грибы с луком, смешать.",
     "healthy", "home", "гречка;нейтральное;ужин", "постно;быстро"),
    ("Печёные овощи", "тыква, картофель, морковь, перец, масло",
     "Запечь нарезанные овощи при 200°C 25–35 мин.",
     "healthy", "healthy", "овощи;печёные;полезное", "вегетарианское;гарнир"),
    ("Ролл с тунцом (домашний)", "рис, нори, тунец, огурец, соус",
     "Сварить рис, собрать ролл, нарезать.",
     "healthy", "japanese", "роллы;суши;рыба", "лёгкое;полезное"),
]


RESTAURANTS = [
    ("PizzaHouse", "Алматы", "ул. Абая 12", "Итальянская", 4.7, "+77001234567",
     "пицца;итальянская;солёное", "маргарита;сыр;пиццерия"),
    ("BurgerLand", "Алматы", "пр. Достык 88", "Американская", 4.6, "+77001112233",
     "бургер;мясо;солёное", "бургеры;фри;фастфуд"),
    ("La Dolce Vita", "Алматы", "ул. Панфилова 33", "Итальянская", 4.9, "+77002223344",
     "сладкое;десерт;кофе", "тирамису;джелато;эспрессо"),
    ("Coffee&Joy", "Алматы", "пр. Назарбаева 77", "Кофейня", 4.9, "+77002221100",
     "кофе;десерт;сладкое", "чизкейк;брауни;эклер"),
    ("GreenBowl", "Алматы", "ул. Жибек Жолы 15", "ЗОЖ-боулы", 4.8, "+77005550101",
     "боул;здоровое;вегетарианское", "смузи;овощи"),
    ("Astana Grill", "Астана", "ул. Сарыарка 21", "Гриль", 4.7, "+77009998877",
     "мясо;гриль;стейки", "bbq;шашлык"),
    ("SweetLife", "Астана", "пр. Тауелсыздык 10", "Кофейня", 4.9, "+77007654321",
     "десерт;сладкое;кофе", "чизкейк;эклер;капучино"),
    ("SpiceHub", "Астана", "ул. Кабанбай батыра 15", "Азиатская", 4.5, "+77009876543",
     "острое;лапша;суп", "рамен;том ям;фо"),
    ("Korean BBQ", "Астана", "ул. Туркестан 5", "Корейская", 4.7, "+77003334455",
     "барбекю;мясо;острое", "кимчи;рамен"),
    ("Sakura", "Астана", "ул. Абылай хана 25", "Японская", 4.8, "+77001110022",
     "суши;роллы;рыба", "сашими;васаби"),
    ("Retro Diner", "Костанай", "ул. Аль-Фараби 10", "Американская", 4.5, "+77007775566",
     "бургер;пицца;милкшейк", "картофель фри"),
    ("TokyoSushi", "Караганда", "пр. Бухар Жырау 20", "Японская", 4.6, "+77006667788",
     "роллы;суши;рыба", "мисо;рамиэн"),
    ("ThaiMood", "Караганда", "ул. Ержанова 15", "Тайская", 4.7, "+77005432123",
     "том ям;пад тай;острое", "кокос;чили"),
    ("Vegan Cafe", "Шымкент", "ул. Толе би 45", "Вегетарианская", 4.8, "+77001239876",
     "полезное;боулы;овощи", "тофу;смузи"),
    ("Oriental Wok", "Шымкент", "ул. Байтурсынова 31", "Азиатская", 4.6, "+77009990077",
     "вок;лапша;курица", "рамен;собо"),
    ("Pasta Fresca", "Алматы", "ул. Сейфуллина 101", "Итальянская", 4.8, "+77005551234",
     "паста;карбонара;песто", "итальянская;сыр"),
    ("Borsh&Co", "Алматы", "ул. Гоголя 52", "Домашняя кухня", 4.6, "+77001231212",
     "борщ;котлеты;пюре", "супы;комбо"),
    ("Ramen Lab", "Алматы", "ул. Курмангазы 19", "Японская/Рамен", 4.7, "+77009991122",
     "рамен;лапша;острое", "мисо;тонкоцу"),
    ("Dessert Bar", "Астана", "ул. Туран 17", "Десерты", 4.8, "+77002224545",
     "эклер;брауни;чизкейк", "муссы;торты"),
    ("Casa Mex", "Астана", "ул. Орынбор 12", "Мексиканская", 4.6, "+77005557878",
     "фахитас;буррито;тако", "чили;острое"),
    ("Greece Light", "Караганда", "ул. Лободы 8", "Греческая", 4.6, "+77001119900",
     "фета;салаты;сувлаки", "оливки;оливковое масло"),
    ("Just Pizza", "Шымкент", "ул. Рыскулова 3", "Пиццерия", 4.7, "+77006660001",
     "пицца;сыр;итальянская", "печь;маргарита"),
    ("Korean Street", "Шымкент", "ул. Кунаева 9", "Корейская уличная", 4.5, "+77003335566",
     "кимбап;ттокпокки;лапша", "острое;стритфуд"),
    ("Salad&Go", "Алматы", "ул. Тимирязева 44", "Салат-бар", 4.7, "+77005550002",
     "цезарь;овощи;соусы", "здоровое;легкое"),
    ("Fish Day", "Астана", "ул. Достык 9", "Рыбный ресторан", 4.7, "+77005550909",
     "лосось;тунец;устрицы", "рыба;гриль"),
    ("Morning Eggs", "Алматы", "ул. Богенбай батыра 25", "Завтраки", 4.8, "+77001234501",
     "омлет;сэндвич;панкейки", "кофе;сироп"),
    ("Boiled&Roasted", "Караганда", "ул. Молокова 6", "Домашняя кухня", 4.6, "+77007773331",
     "котлеты;пюре;суп", "обед;домой"),
    ("Sweets & Treats", "Костанай", "ул. Байзакова 7", "Кондитерская", 4.8, "+77004445566",
     "эклер;маффины;торты", "десерты;кофе"),
    ("BBQ Yard", "Шымкент", "ул. Сапак Датка 27", "Барбекю", 4.6, "+77002229988",
     "гриль;ребрышки;мясо", "стейки;растопка"),
    ("Tokyo Express", "Астана", "ул. Кунаева 11", "Суши-роллы", 4.5, "+77009994444",
     "роллы;суши;мисо", "японская;васаби"),
]


def seed_recipes(conn):
    conn.execute("DELETE FROM recipes")
    prepared = [
        (
            title,
            ingredients,
            steps,
            category,
            cuisine,
            media_for_category(category),
            tags,
            keywords,
        )
        for title, ingredients, steps, category, cuisine, tags, keywords in RECIPES
    ]
    conn.executemany(
        """
        INSERT INTO recipes(title, ingredients, steps, category, cuisine, reaction, tags, keywords)
        VALUES (?,?,?,?,?,?,?,?)
        """,
        prepared,
    )


def seed_restaurants(conn):
    conn.execute("DELETE FROM restaurants")
    prepared = [
        (
            name,
            city,
            address,
            cuisine,
            rating,
            contact,
            tags,
            media_for_tags(tags),
            keywords,
        )
        for name, city, address, cuisine, rating, contact, tags, keywords in RESTAURANTS
    ]
    conn.executemany(
        """
        INSERT INTO restaurants(name, city, address, cuisine, rating, contact, tags, reaction, keywords)
        VALUES (?,?,?,?,?,?,?,?,?)
        """,
        prepared,
    )


def seed_synonyms(conn):
    conn.execute("DELETE FROM synonyms")
    rows = [(word, ",".join(set(values))) for word, values in SYNONYMS.items()]
    conn.executemany(
        "INSERT OR IGNORE INTO synonyms(word, alt_words) VALUES(?,?)",
        rows,
    )


def main():
    init_db()
    with closing(get_conn()) as conn, conn:
        seed_recipes(conn)
        seed_restaurants(conn)
        seed_synonyms(conn)
    print("✅ Database seeded (FindFood 4.0)")


if __name__ == "__main__":
    main()
